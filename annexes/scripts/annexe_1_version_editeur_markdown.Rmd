---
title: "Annexe 1"
author: "Jean-Yves Barnagaud - Olivier Gimenez"
date: "juin 2023"
output: word_document
editor_options:
chunk_output_type: console
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment='>',tidy=F, class.source='bg-warning', class.output='bg-success')
knitr::opts_knit$set(root.dir = "A:/projets/projet_stats/dossier_editeur/Barnagaud_Gimenez_version_07_2023/annexes")
```

ATTENTION : MODIFIER LE CHEMIN D'ACCES VERS VOTRE REPERTOIRE COURANT AVANT DE LANCER CE SCRIPT

# librairies utiles et options du script

## librairies

```{r}
# génériques
library(tidyverse)
library(formatR)
library(jtools)
library(reshape2)

# graphiques
library(patchwork)
library(viridis)
library(ggplot2)
library(cowplot)
```

## répertoire courant 

Attention : le répertoire de travail est changé dans l'en-tête du script Markdown.

```{r, eval = F}
setwd("A:/Biotope_analyse_donnees/annexes")
```

## options graphiques

Thème par défaut des graphiques

```{r}
theme_set(theme_light(base_size = 16))
```

Reproductibilité des simulations

```{r}
set.seed(150)
```

# 2-	Comparer deux échantillons au regard d’une variable quantitative

données : 

```{r}
mesanges <-
  read.csv2("donnees/mesanges_Caro_et_al_PRSLB_2019.csv", dec = ".")
mesanges
```

on repasse ce jeu de données dans un format "long" plus facile à manipuler
```{r}
mesanges.long <- pivot_longer(mesanges, cols = c("T0", "T30"))
colnames(mesanges.long) <- c("individu", "traitement", "concentration")
```

histogramme des données : 
```{r}
ggplot(mesanges.long)+
  aes(x = concentration,fill = traitement)+
  geom_histogram(bins=9,color = 'black')+
  labs(x="Concentration en oestradiol (pg/ml)",y="Effectif") + 
  scale_fill_viridis_d()+
  theme_classic()
```

```{r,echo = F, eval = F}
ggsave("outputs/A1F2.png",width = 6, height = 6)
```

visualisation des liens entre groupes
```{r}
png(
  filename = "outputs/A1F3.png",
  width = 20,
  height = 20,
  units = "cm",
  res = 300,
  bg = 'white'
)
plot(
  c(rep(0.5, 16), rep(1.5, 16)),
  c(mesanges[, 2], mesanges[, 3]),
  xlim = c(0, 2),
  xaxt = "n",
  bty = "l",
  xlab = "échantillon",
  ylab = "concentration en oestradiol (pg/ml)",
  pch = 21,
  bg = "black",
  cex.lab = 1.5
)
axis(
  side = 1,
  at = c(0.5, 1.5),
  labels = c("T=0 min", "T=30min")
)
segments(
  x0 = rep(0.5, 16),
  x1 = rep(1.5, 16),
  y0 = mesanges[, 2],
  y1 = mesanges[, 3]
)
dev.off()
```

La différence entre les deux groupes : 

```{r}
mesanges$delta <- apply(mesanges[, -1], FUN = "diff", MARGIN = 1)
mesanges
```

On range les valeurs
```{r}
mesanges <- mesanges[order(abs(mesanges$delta)), ]
mesanges$rang <- rank(abs(mesanges$delta))
mesanges
```

sommes des rangs
```{r}
sum(mesanges[which(mesanges$delta > 0), "rang"])
sum(mesanges[which(mesanges$delta < 0), "rang"])
```

test de Wilcoxon
```{r}
wilcox.test(mesanges[,2],mesanges[,3],paired=T)
```

test de Mann Whitney
```{r,eval=F}
wilcox.test(échantillon 1,échantillon 2,paired=F)
```

# 3-	Comparer des fréquences

données

```{r}
proc.migr <- read.csv2("donnees/procellariiformes.csv", dec = ".")

proc.migr$species <- factor(proc.migr$species)
proc.migr$Migratory.mode <- factor(proc.migr$Migratory.mode)
proc.migr$Nest.type <- factor(proc.migr$Nest.type)

head(proc.migr)
dim(proc.migr)
summary(proc.migr)
```

table de contingence en effectifs

```{r}
table(proc.migr[,-1]) 
```

table de contingence en fréquences:

```{r}
table(proc.migr[,-1])/68
```

table de contingence théorique sous l'attendu de répartition aléatoire :

```{r}
chisq.test(proc.migr$Migratory.mode,proc.migr$Nest.type)$expected
```

loi de chi² à 1 degré de liberté

```{r}
png(
  filename = "outputs/A1F5.png",
  width = 20,
  height = 20,
  units = "cm",
  res = 300,
  bg = 'white'
)

chisq1 <- rchisq(100, 1)
curve(
  dchisq(x, df = 1),
  from = 0,
  to = 20,
  main = "",
  bty = "n",
  xlab = "Chi² à 1 degré de liberté",
  ylab = "Densité"
)

abline(
  v = 18.7,
  col = "steelblue",
  lty = "dashed",
  lwd = 2
)
dchisq(18.77, 1)

dev.off()
```

test du chi²

```{r}
chisq.test(proc.migr$Migratory.mode,proc.migr$Nest.type)
```

### Le cas des échantillonnages déséquilibrés

```{r}
passereaux <- read.csv2("donnees/traits_passereaux.csv", dec = ".")

passereaux$species <- factor(passereaux$species)
passereaux$Migratory.mode <- factor(passereaux$Migratory.mode)
passereaux$Social.system <- factor(passereaux$Social.system)

head(passereaux)
summary(passereaux)
```

table de contingence : on compare les modes migratoires et la socialité

```{r}
table(passereaux[,c("Migratory.mode","Social.system")])
```

on essaie un chi2

```{r}
chisq.test(passereaux$Migratory.mode,passereaux$Social.system) 
```

l'avertissement vient du fait que les hypothèses du chi² ne sont pas respectée : plusieurs effectifs attendus sont très faibles

```{r}
chisq.test(passereaux$Migratory.mode,passereaux$Social.system)$expected 
```

on passe par un test exact de Fisher

```{r}
fisher.test(passereaux$Migratory.mode,passereaux$Social.system)
```



